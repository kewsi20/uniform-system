<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Toi Toi Uniform Inventory System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="container py-4">
  <h2 class="mb-4">👕 Toi Toi Inventory System</h2>

  <!-- 員工選擇 -->
  <div class="mb-3">
    <label for="employeeSelect" class="form-label">Staff List</label>
    <select id="employeeSelect" class="form-select"></select>
  </div>

  <!-- Excel 上傳 -->
  <div class="mb-3">
    <label for="excelUpload" class="form-label">Upload Staff List（Excel）</label>
    <input type="file" id="excelUpload" class="form-control" accept=".xlsx,.xls" onchange="handleExcel(event)">
  </div>

  <!-- 領取表單 -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Uniform Type</label>
      <select id="type" class="form-select">
        <option>T-shirt</option>
        <option>Pants</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Size</label>
      <select id="size" class="form-select">
        <option>S</option><option>M</option><option>L</option><option>XL</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Quantity</label>
      <input type="number" id="quantity" class="form-control" min="1" value="1">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Date of Pick Up</label>
    <input type="date" id="date" class="form-control" value="2025-08-15">
  </div>

  <button class="btn btn-primary mb-4" onclick="submitRecord()">Submit</button>

  <!-- 庫存顯示 -->
  <h4>📦 Current Stock</h4>
  <table class="table table-bordered" id="inventoryTable"></table>

  <!-- 新增庫存 -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">New uniform Addition</label>
      <select id="editType" class="form-select"><option>T-shirt</option><option>Pants</option></select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Size</label>
      <select id="editSize" class="form-select"><option>S</option><option>M</option><option>L</option><option>XL</option></select>
    </div>
    <div class="col-md-4">
      <label class="form-label">New Addition Size</label>
      <input type="number" id="editQty" class="form-control">
    </div>
  </div>
  <button class="btn btn-success mb-4" onclick="addInventory()">New Addition Stock</button>

  <!-- PDF 報表 -->
  <h4>📄 Download Report</h4>
  <button class="btn btn-secondary" onclick="downloadPDF()">Download PDF（Draft）</button>

  <script>
    let employees = {};
    const inventory = {
      "T-shirt": { S: 0, M: 0, L: 0, XL: 0, XXL: 0, XXXL: 0, XXXXL: 0 },
      "Pants":   { S: 0, M: 0, L: 0, XL: 0, XXL: 0, XXXL: 0, XXXXL: 0 }
    };
    const records = [];

    function populateEmployees() {
      const select = document.getElementById("employeeSelect");
      select.innerHTML = "";
      for (let id in employees) {
        const option = document.createElement("option");
        option.value = id;
        option.text = `${id} - ${employees[id]}`;
        select.appendChild(option);
      }
    }

    function handleExcel(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        employees = {};
        rows.forEach(row => {
          if (row["Employee ID"] && row["Name"]) {
            employees[row["Employee ID"]] = row["Name"];
          }
        });
        populateEmployees();
        alert("員工名單已匯入！");
      };
      reader.readAsArrayBuffer(file);
    }

    function updateInventoryTable() {
      const table = document.getElementById("inventoryTable");
      table.innerHTML = "<tr><th>Type</th><th>Size</th><th>Quantity</th></tr>";
      for (let type in inventory) {
        for (let size in inventory[type]) {
          table.innerHTML += `<tr><td>${type}</td><td>${size}</td><td>${inventory[type][size]}</td></tr>`;
        }
      }
    }

    function submitRecord() {
      const id = document.getElementById("employeeSelect").value;
      const type = document.getElementById("type").value;
      const size = document.getElementById("size").value;
      const qty = parseInt(document.getElementById("quantity").value);
      const date = document.getElementById("date").value;
      if (inventory[type][size] >= qty) {
        inventory[type][size] -= qty;
        records.push({ id, name: employees[id], type, size, qty, date });
        alert("領取成功！");
        updateInventoryTable();
      } else {
        alert("庫存不足！");
      }
    }

    function addInventory() {
      const type = document.getElementById("editType").value;
      const size = document.getElementById("editSize").value;
      const qty = parseInt(document.getElementById("editQty").value);
      if (!isNaN(qty)) {
        inventory[type][size] += qty;
        updateInventoryTable();
        alert(`已新增 ${qty} 件 ${type} 尺寸 ${size}`);
      }
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(12);
      doc.text("制服領取報表", 10, y); y += 10;

      const grouped = {};
      records.forEach(r => {
        if (!grouped[r.id]) grouped[r.id] = { name: r.name, pickups: [] };
        grouped[r.id].pickups.push(`${r.date}：${r.type} 尺寸 ${r.size} x${r.qty}`);
      });

      for (let id in grouped) {
        doc.text(`Employee ID：${id}`, 10, y); y += 6;
        doc.text(`Name：${grouped[id].name}`, 10, y); y += 6;
        doc.text("Pick Up Record：", 10, y); y += 6;
        grouped[id].pickups.forEach(p => {
          doc.text(`- ${p}`, 15, y); y += 6;
        });
        y += 4;
      }

      doc.text("Current Stock：", 10, y); y += 6;
      for (let type in inventory) {
        for (let size in inventory[type]) {
          doc.text(`${type} 尺寸 ${size}：${inventory[type][size]} 件`, 15, y); y += 6;
        }
      }

      doc.save("制服領取報表.pdf");
    }

    updateInventoryTable();
  </script>
</body>
</html>
